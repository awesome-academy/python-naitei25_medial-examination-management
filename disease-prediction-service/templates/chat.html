<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chẩn đoán bệnh AI - Chat</title>
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica,
          Arial, Noto Sans, "Apple Color Emoji", "Segoe UI Emoji";
        background: #f5f7fb;
      }
      .app {
        max-width: 740px;
        margin: 0 auto;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }
      .topbar {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 16px;
        background: #0ea5e9;
        color: #fff;
        font-weight: 600;
      }
      .chat {
        flex: 1;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .bubble {
        max-width: 75%;
        padding: 12px 14px;
        border-radius: 14px;
        line-height: 1.4;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
      }
      .bot {
        background: #fff;
        align-self: flex-start;
      }
      .user {
        background: #22c55e;
        color: #fff;
        align-self: flex-end;
      }
      .chips {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 8px;
      }
      .chip {
        background: #e6f3ff;
        color: #0369a1;
        padding: 8px 12px;
        border-radius: 999px;
        cursor: pointer;
        border: 1px solid #cfe7ff;
      }
      .chip:hover {
        background: #d7ecff;
      }
      .composer {
        position: sticky;
        bottom: 0;
        background: #fff;
        padding: 12px;
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
        border-top: 1px solid #eef2f7;
      }
      .input {
        width: 100%;
        padding: 12px 14px;
        border: 1px solid #dbe2ea;
        border-radius: 10px;
        outline: none;
      }
      .send {
        background: #0ea5e9;
        color: #fff;
        border: 0;
        padding: 0 18px;
        border-radius: 10px;
        cursor: pointer;
      }
      .send:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .result {
        background: #fff7ed;
        border: 1px solid #ffedd5;
        color: #9a3412;
      }
      .muted {
        color: #64748b;
        font-size: 12px;
        margin-top: 6px;
      }
    </style>
  </head>
  <body>
    <div class="app">
      <div class="topbar">Chẩn đoán bệnh AI</div>
      <div id="chat" class="chat"></div>
      <div class="composer">
        <input
          id="text"
          class="input"
          placeholder="Nhập triệu chứng (VD: Tôi bị ho, sốt, đau đầu)"
        />
        <button id="send" class="send" onclick="onSend()">Gửi</button>
      </div>
    </div>

    <script>
      const symptoms = {{ symptoms | tojson }}; // {en: vn}
      const chat = document.getElementById('chat');
      const input = document.getElementById('text');
      const sendBtn = document.getElementById('send');
      let selected = new Set();
      let sessionSymptoms = new Set();

      function addBot(text, extraHTML = '') {
        const div = document.createElement('div');
        div.className = 'bubble bot';
        div.innerHTML = `${text}${extraHTML}`;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
      }

      function addUser(text) {
        const div = document.createElement('div');
        div.className = 'bubble user';
        div.textContent = text;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
      }

      function intro() {
        addBot('Xin chào! Tôi là trợ lý AI chẩn đoán bệnh. Hãy mô tả các triệu chứng bạn đang gặp phải nhé.');
        // Suggest a few popular symptoms as chips
        const candidates = ['headache','fever','cough','abdominal pain','sore throat','back pain'];
        const chips = candidates.filter(k => symptoms[k]).map(k => ({key:k, label:symptoms[k]}));
        const html = `<div class="chips">${chips.map(c => `<span class="chip" data-key="${c.key}">${c.label}</span>`).join('')}</div><div class="muted">Bạn có thể chọn nhanh ở trên hoặc nhập tự do bên dưới. Khi xong, bấm "Kết thúc" để dự đoán.</div>`;
        addBot('Gợi ý triệu chứng:', html);
      }

      // Event delegation for chip clicks (triệu chứng và hành động)
      chat.addEventListener('click', (e) => {
        const chip = e.target.closest('.chip');
        if (!chip) return;
        const action = chip.getAttribute('data-action');
        if (action === 'finish') { predictNow(); return; }
        if (action === 'restart') { restart(); return; }
        const key = chip.getAttribute('data-key');
        if (!key) return;
        // Treat clicking a symptom chip as sending a user message immediately
        addUser(symptoms[key] || key);
        if (!sessionSymptoms.has(key)) {
          sessionSymptoms.add(key);
        }
        chip.style.background = '#d7ecff';

        renderFollowup();
        chat.scrollTop = chat.scrollHeight;
        return;
      });

      async function onSend() {
        const text = input.value.trim();
        if (!text && selected.size === 0) return;
        if (text) addUser(text);

        // Phân tích text thành triệu chứng
        let parsed = [];
        if (text) {
          try {
            const res = await fetch('/api/parse-symptoms', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ text }) });
            const data = await res.json();
            parsed = data.matched_symptoms || [];
            if (parsed.length) {
              addBot('Tôi nhận biết các triệu chứng:', `<div class="chips">${parsed.map(k => `<span class='chip'>${symptoms[k]}</span>`).join('')}</div>`);
            } else {
              addBot('Tôi chưa nhận ra triệu chứng nào từ tin nhắn, bạn có thể thử diễn đạt khác hoặc chọn từ gợi ý.');
            }
          } catch (e) {
            addBot('Có lỗi khi phân tích triệu chứng.');
          }
        }

        // Gộp vào bộ triệu chứng của phiên
        const justAdded = Array.from(new Set([...parsed, ...selected]))
          .filter(k => !sessionSymptoms.has(k));
        justAdded.forEach(k => sessionSymptoms.add(k));

        if (sessionSymptoms.size === 0) { input.value = ''; return; }

        // Hỏi còn triệu chứng nào khác không + gợi ý từ database + nút Kết thúc
        renderFollowup();

        // reset lựa chọn lượt này
        selected.clear();
        input.value = '';
      }

      async function renderFollowup() {
        const summary = Array.from(sessionSymptoms).map(k => `<span class='chip'>${symptoms[k]}</span>`).join('');
        // Lấy gợi ý từ API dựa trên các triệu chứng đã chọn (chỉ từ DB)
        let suggestions = [];
        try {
          const res = await fetch('/api/parse-symptoms', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ text: '', chosen: Array.from(sessionSymptoms) }) });
          const data = await res.json();
          suggestions = (data.suggestions || []).slice(0, 8);
        } catch (e) {}
        const sugChips = suggestions.map(k => `<span class='chip' data-key='${k}'>${symptoms[k] || k}</span>`).join('');
        const extra = `<div class='chips'>${summary}</div>` + (sugChips ? `<div class='muted'>Gợi ý liên quan:</div><div class='chips'>${sugChips}</div>` : '') + `<div class='chips'><span class='chip' data-action='finish'>Kết thúc</span></div>`;
        addBot('Bạn còn triệu chứng nào khác không?', extra);
      }

      async function predictNow() {
        if (sessionSymptoms.size === 0) { addBot('Bạn chưa cung cấp triệu chứng nào.'); return; }
        sendBtn.disabled = true;
        try {
          const res = await fetch('/api/predict', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ symptoms: Array.from(sessionSymptoms) }) });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || 'Predict error');

          const top = data.top_predictions || [];
          const html = `
            <div class='bubble result bot'>
              <div><strong>Kết quả chính:</strong> ${data.predicted_disease_vn} <span class='muted'>(${(data.confidence*100).toFixed(1)}%)</span></div>
              <div class='muted' style='margin-top:8px;'>Top dự đoán:</div>
              <div class='chips' style='margin-top:6px;'>
                ${top.map(p => `<span class='chip'>${p.disease_vn} ${(p.probability*100).toFixed(0)}%</span>`).join('')}
              </div>
              <div class='muted' style='margin-top:8px;'>Bạn muốn bắt đầu chẩn đoán mới?</div>
              <div class='chips' style='margin-top:6px;'><span class='chip' data-action='restart'>Bắt đầu mới</span></div>
            </div>`;
          chat.insertAdjacentHTML('beforeend', html);
          chat.scrollTop = chat.scrollHeight;
        } catch (e) {
          addBot('Không dự đoán được. Vui lòng thử lại.');
        } finally {
          sendBtn.disabled = false;
        }
      }

      function restart() {
        selected.clear();
        sessionSymptoms.clear();
        addBot('Hãy mô tả các triệu chứng bạn đang gặp phải.');
      }

      // Send on Enter
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          onSend();
        }
      });

      document.addEventListener('DOMContentLoaded', intro);
    </script>
  </body>
</html>
